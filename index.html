<html>
<head>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="node_modules/d3/d3.js" charset="utf-8"></script>
	<script src="node_modules/underscore/underscore.js" charset="utf-8"></script>
	<script src="node_modules/js-combinatorics/combinatorics.js"></script>
	<style type="text/css" media="screen">
	body{
		font: 150% "Helvetica";
	}
	h1{
		text-align:center;
	}
	.canvas{
		width:80%;
		margin-left:auto;
		margin-right:auto;
		display:block;
		border:1px solid black;
		background-color:#eee;
		height:500px;
	}
	.boxfill{
		font: 100% "Helvetica";
		z-index:2;
	}
	.box{
		z-index:1;
		fill:white;
		stroke:black;
	}
	input{
		width:40px;
		margin:5px;
	}
	input#dim{
		width:15px;
	}
	#input{
		width:80%;
		font-size:50%;
		margin-left:auto;
		margin-right:auto;
	}
	#colo{
		width:80%;
		margin-left:auto;
		margin-right:auto;
		font-size: 50%;
	}

	</style>
</head>
<body>
	<h1>Young Tableaux</h1>
	<div id="input">
		SU(<input id="dim" type="text" value="3">)
		<input id="one" type="text" value="2,1">x<input id="two" type="text" value="2,1"><button type="button" id="button">decompose</button>
	</div>
	<svg class="canvas" onclick=></svg>
	<script type="text/javascript" charset="utf-8">

	var scale = d3.scale.linear().domain([0,20]).range([0,600])

	function addbox(boxes){
		var box = boxes.append("g");

		box.attr("class","boxgroup");

		box.append("rect")
			.attr("x",function(d,i,j){return scale(i);})
			.attr("y",function(d,i,j){return scale(j);})
			.attr("height",scale(1))
			.attr("width",scale(1))
			.attr("class","box");
		box.append("text")
			.attr("x",function(d,i,j){return scale(i);})
			.attr("y",function(d,i,j){return scale(j);})
			.attr("text-anchor","middle")
			.attr("alignment-baseline","central")
			.attr("dx", scale(0.5))
			.attr("dy", scale(0.5))
			.attr("class","boxfill")
			.text(function(d){return d;});
		return box;
	}

	function mktbl(canvas,id,tab,pos){
		var tbl = canvas.append("g");
		var boxes = tbl
			.attr("id",id)
			.attr("transform","translate("+scale(pos[0])+","+scale(pos[1])+")")
			.selectAll("g g").data(tab)
			.enter()
			.append("g")
			.attr("class","row")
			.selectAll("g").data(function(d,i,j){return d;})
			.enter().call(addbox)
		return d3.selectAll("#"+id);
	}

	function newbox(boxes){
		var b = addbox(boxes)
				.style("opacity","0");
		b.selectAll("rect").style("fill","red")
		b.transition().duration(500)
		 .style("opacity","1")
		b.selectAll("rect").transition().delay(300).duration(100).style("fill","white");
	}
	
	tab1 = [[,,],[,]];
	tab2 = [[1,1,],[2,]];
	var canvas = d3.selectAll(".canvas");
	


	function update(id,data){
		m = d3.select(id).selectAll(".row").data(data)
			.selectAll(".boxgroup").data(function(d){return d;});
		m.enter().call(newbox);
		m.exit().style("opacity","1").transition().duration(1500).style("opacity","0").remove();
	}

	// one = [[,,1],[,]]
	// two = [[1,],[2,]]


	// mktbl(canvas,"tab3",tab1,[1,5]);
	// 
	// // a.transition().attr("transform","translate("+scale(7)+","+scale(5)+")")
	// 
	// $("#tab3").click(function(){update("#tab3",one)});
	// // update("#tab4",two);

	// $("#tab4 .row .boxgroup .boxfill").unwrap().unwrap();
	// a.selectAll(".box").transition().duration(1500).style("opacity",0).remove();


	function partitions(nbox,extension,nrow,nmax){
		var nb = nbox
		var mx = typeof nmax === 'undefined' ? nbox : nmax
		var ro = nrow || nbox
		var ex = extension || Array(nb+1).join(0).split('').map(function(){return 0;})
		if (ex.length > 0){
			ex = ex.concat([0])
		}
		else{
			ex = [0]
		}
		if(nb == 0){return undefined}
		var parts = [];
		var minval = Math.max(0,Math.ceil((_.reduce(ex,function(x,y){return x+y},0)+nb)/ro)-ex[0])
		var maxval = Math.min(nb,mx)
		_.range(minval,maxval+1).forEach(
			function(e){
				var rm = nb-e;
				var rest = partitions(rm,ex.slice(1),ro-1,ex[0]+e-ex[1]);
				if(typeof rest === 'undefined'){
					parts.push([e])
				}
				else{
					rest.forEach(function(x){
						parts.push([e].concat(x))
					})
				}
			}
		)
		return parts		
	}

	function fill(content,part){
		return part.map(function(x,i){
		return content.slice(part.slice(0,i).reduce(function(x,y){return x+y},0),
						  	 part.slice(0,i).reduce(function(x,y){return x+y},0)+x)})
	}

	function diagram(part){
		return part.map(function(x){return Array(x)})
	}
	
	function merge(a,b){
		return _.zip(a,b).map(function(x){return x.map(function(y){return typeof y === 'undefined' ? Array(0) : y})}).map(function(pair){return pair[0].concat(pair[1])})
	}
	
	function getfills(part){
		return Combinatorics.permutation(part.map(function(e,i){
			return Array(e+1).join().split('').map(function(){
				return i+1
			}
			)
		}).reduce(function(x,y){return x.concat(y)},[])).toArray()
	}
	
	function isstandard(tab){
		var cols = _.zip.apply(_,tab).map(_.compact)
		colsok = _.every(cols.map(function(c){return _.every(c.slice(1).map(function(x,i){return c[i]<x}))}))
		rowsok = _.every(tab.map(_.compact).map(function(c){
			return _.every(c.slice(1).map(function(x,i){return c[i]<=x}))}))
		return colsok && rowsok;
	}
	
	function isrevlattice(tab){
		var word = tab.slice(0).reverse().map(_.compact).reduce(function(x,y){return x.concat(y)})
		var counts = _.range(word.length).map(function(x){
			return _.uniq(word).sort().map(function(v){
				return _.filter(word.slice(x),function(z){return z==v}).length
			})
		})
		return _.every(counts.map(function(c){
			return _.every(c.slice(1).map(function(x,i){return c[i]>=x}))
		}))
	}
	
	function dimension(part,n){
		var distances = _.flatten(part.map(function(l,r){return _.range(l).map(function(i){return n+i-r})}))
		var tr = _.range(_.max(part)).map(function(i){return _.compact(part.map(function(v){if((v-i) > 0){return v-i}})).length})
		var hooks = _.flatten(_.zip(_.range(part[0]),tr).map(function(il){return _.range(il[1]).map(function(j){return part[j]-il[0]+tr[il[0]]-j-1})}))
		return Math.round(_.zip(distances,hooks).map(function(x){return x[0]/x[1]}).reduce(function(x,y){return x*y}))
	}
	
	function decompose(first,second,dim){
		var tabs = []
		var boxes = second.reduce(function(x,y){return x+y})
		Combinatorics.cartesianProduct(getfills(second),partitions(boxes,first,dim))
					 .toArray().forEach(function(x){
						 var a = merge(diagram(first),fill(x[0],x[1]))
						 var p = a.map(function(r){return r.length})
						 var seen = _.some(tabs.map(function(t){return _.isEqual(t,a)}))
						 if (isstandard(a) && isrevlattice(a) && !seen){tabs.push(a)}
		})
		return tabs
	}

	function run(one,two,dim){
		var to = mktbl(canvas,"tabone",diagram(one),[1,1]);
		var tt = mktbl(canvas,"tabtwo",diagram(two),[6,1]);
		to.append("text").attr("y",scale(4)).text(dimension(one,dim))
		tt.append("text").attr("y",scale(4)).text(dimension(two,dim))
	
		var decomp = decompose(one,two,dim)
	
		decomp.forEach(function(x,i){
			t = mktbl(canvas,"tab"+i,x,[1+5*i,10]);
			t.append("text").attr("y",scale(5)).text(dimension(x.map(function(r){return r.length}),dim))
		})
	}
	
	$("#button").click(function(){
		$("svg").empty()
		var one = $("input#one").val().split(",").map(function(x){return parseInt(x)})
		var two = $("input#two").val().split(",").map(function(x){return parseInt(x)})
		run(one,two,parseInt($("input#dim").val()))		
	})
	
	
	</script>
	<div id="colo">contact: Lukas Heinrich lukas.heinrich(at)cern.ch</div>
</body>
</html>